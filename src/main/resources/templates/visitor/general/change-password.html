<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Смена пароля | СИАРСП</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/javascript.js"></script>
</head>
<body class="auth-page">
<div class="auth-container">
    <div class="auth-card">
        <form action="/visitor/change-password" method="post" id="passwordForm" class="auth-form">

            <h1 class="page-title">Смена пароля</h1>
            <p class="page-subtitle">Установите новый пароль</p>

            <div th:if="${passwordError}" class="alert alert-danger" th:text="${passwordError}"></div>

            <div class="mb-3">
                <input type="password" name="passwordNew" id="passwordNew"
                       placeholder="Введите новый пароль"
                       class="form-control" required>
                <div class="password-strength">
                    <small id="strengthIndicator" class="fw-bold text-muted"></small>
                </div>
            </div>

            <div class="mb-3">
                <input type="password" name="passwordConfirm" id="passwordConfirm"
                       placeholder="Подтвердите новый пароль"
                       class="form-control" required>
                <div class="password-strength">
                    <small id="matchMessage" class="fw-bold" style="display: none;"></small>
                </div>
            </div>

            <div class="form-check mb-4">
                <input type="checkbox" class="form-check-input" id="togglePassword">
                <label class="form-check-label" for="togglePassword">Показать пароли</label>
            </div>

            <button type="submit" id="submitBtn" class="w-100 btn btn-auth">
                Сменить пароль
            </button>

            <div class="divider">
                <span>или</span>
            </div>

            <div class="link-section">
                <a href="/visitor/profile">← На страницу профиля</a>
            </div>

        </form>
    </div>
</div>

<script>
    const passwordNew = document.getElementById('passwordNew');
    const passwordConfirm = document.getElementById('passwordConfirm');
    const submitBtn = document.getElementById('submitBtn');
    const matchMessage = document.getElementById('matchMessage');
    const strengthIndicator = document.getElementById('strengthIndicator');
    const togglePassword = document.getElementById('togglePassword');

    togglePassword.addEventListener('change', () => {
        const type = togglePassword.checked ? 'text' : 'password';
        passwordNew.type = type;
        passwordConfirm.type = type;
    });

    function getPasswordStrength(password) {
        if (password.length < 6) return { level: "Слабый", class: "text-danger" };
        if (password.match(/[A-Z]/) && password.match(/[a-z]/) && password.match(/[0-9]/) && password.length >= 8)
            return { level: "Сильный", class: "text-success" };
        return { level: "Средний", class: "text-warning" };
    }

    function validateForm() {
        const pwd = passwordNew.value;
        const confirmPwd = passwordConfirm.value;

        if (pwd) {
            const strength = getPasswordStrength(pwd);
            strengthIndicator.textContent = "Надёжность: " + strength.level;
            strengthIndicator.className = `fw-bold ${strength.class}`;
        }

        if (pwd && confirmPwd && pwd !== confirmPwd) {
            matchMessage.textContent = "Пароли не совпадают";
            matchMessage.className = "fw-bold text-danger";
            matchMessage.style.display = "block";
            passwordConfirm.classList.add("is-invalid");
            passwordConfirm.classList.remove("is-valid");
            submitBtn.disabled = true;
        } else if (pwd && confirmPwd && pwd === confirmPwd) {
            matchMessage.textContent = "Пароли совпадают";
            matchMessage.className = "fw-bold text-success";
            matchMessage.style.display = "block";
            passwordConfirm.classList.remove("is-invalid");
            passwordConfirm.classList.add("is-valid");
            submitBtn.disabled = false;
        } else {
            matchMessage.style.display = "none";
            passwordConfirm.classList.remove("is-valid", "is-invalid");
            submitBtn.disabled = true;
        }
    }

    passwordNew.addEventListener('input', validateForm);
    passwordConfirm.addEventListener('input', validateForm);
</script>
</body>
</html>