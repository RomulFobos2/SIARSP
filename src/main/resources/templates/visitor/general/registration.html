<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Регистрация | СИАРСП</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/javascript.js"></script>
</head>
<body class="auth-page">
<!-- Убрали <div class="container"> -->
<div class="auth-container auth-container--wide">
    <div class="auth-card">
        <form action="/visitor/registration" method="post" id="registrationForm" class="auth-form">

            <div class="logo-container logo-container--large">
                <img src="/images/logo%20—%20копия.png" alt="СИАРСП Logo">
            </div>

            <h1 class="page-title">Регистрация</h1>
            <p class="page-subtitle">Создайте аккаунт для доступа к системе</p>

            <div th:if="${usernameError}" class="alert alert-danger" th:text="${usernameError}"></div>
            <div th:if="${passwordError}" class="alert alert-danger" th:text="${passwordError}"></div>
            <div th:if="${birthdayError}" class="alert alert-danger" th:text="${birthdayError}"></div>

            <div class="mb-4">
                <h6 class="form-section-title">Личные данные</h6>

                <div class="row g-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" name="inputLastName"
                               id="inputLastName" required placeholder="Фамилия">
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" name="inputFirstName"
                               id="inputFirstName" required placeholder="Имя">
                    </div>
                    <div class="col-12">
                        <input type="text" class="form-control" name="inputPatronymicName"
                               id="inputPatronymicName" required placeholder="Отчество">
                    </div>
                    <div class="col-md-6">
                        <select class="form-select" name="inputSex" id="inputSex" required>
                            <option selected disabled value="">Выберите пол</option>
                            <option value="Мужской">Мужской</option>
                            <option value="Женский">Женский</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <input type="date" name="birthday" id="birthday"
                               class="form-control" required th:max="${maxDate}">
                    </div>
                    <div class="col-12">
                        <input type="tel" name="inputMobileNumber" id="inputMobileNumber"
                               placeholder="Номер телефона (+7XXXXXXXXXX)"
                               pattern="(\+7|8)\d{10}"
                               class="form-control"
                               title="Введите номер телефона в формате +7XXXXXXXXXX или 8XXXXXXXXXX"
                               required>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <h6 class="form-section-title">Данные аккаунта</h6>

                <div class="mb-3">
                    <input type="email" name="username" id="username"
                           placeholder="Адрес электронной почты"
                           class="form-control" required>
                    <small id="usernameFeedback" class="fw-bold"></small>
                </div>

                <div class="mb-3">
                    <input type="password" name="password" id="password"
                           placeholder="Пароль" class="form-control" required>
                    <div class="password-strength">
                        <small id="strengthIndicator" class="fw-bold text-muted"></small>
                    </div>
                </div>

                <div class="mb-3">
                    <input type="password" name="passwordConfirm" id="passwordConfirm"
                           placeholder="Подтвердите пароль" class="form-control" required>
                    <div class="password-strength">
                        <small id="matchMessage" class="fw-bold" style="display: none;"></small>
                    </div>
                </div>

                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="togglePassword">
                    <label class="form-check-label" for="togglePassword">
                        Показать пароли
                    </label>
                </div>
            </div>

            <button type="submit" class="w-100 btn btn-auth" id="submitBtn">
                Зарегистрироваться
            </button>

            <div class="divider">
                <span>или</span>
            </div>

            <div class="link-section">
                <p class="mb-2">Уже есть аккаунт? <a href="/visitor/login">Войти</a></p>
                <a href="/">← Вернуться на главную</a>
            </div>

        </form>
    </div>
</div>

<script>
    const form = document.getElementById('registrationForm');
    const phoneInput = document.getElementById('inputMobileNumber');
    const birthdayInput = document.getElementById('birthday');
    const emailInput = document.getElementById('username');
    const password = document.getElementById('password');
    const passwordConfirm = document.getElementById('passwordConfirm');
    const strengthIndicator = document.getElementById('strengthIndicator');
    const matchMessage = document.getElementById('matchMessage');
    const submitBtn = document.getElementById('submitBtn');
    const togglePassword = document.getElementById('togglePassword');
    const usernameFeedback = document.getElementById('usernameFeedback');

    togglePassword.addEventListener('change', () => {
        const type = togglePassword.checked ? 'text' : 'password';
        password.type = type;
        passwordConfirm.type = type;
    });

    function getPasswordStrength(pwd) {
        if (pwd.length < 6) return { level: "Слабый", class: "text-danger" };
        if (pwd.match(/[A-Z]/) && pwd.match(/[a-z]/) && pwd.match(/[0-9]/) && pwd.length >= 8)
            return { level: "Сильный", class: "text-success" };
        return { level: "Средний", class: "text-warning" };
    }

    function validateFormFields() {
        let valid = true;

        if (phoneInput.value && !/^(\+7|8)\d{10}$/.test(phoneInput.value)) {
            phoneInput.classList.add("is-invalid");
            phoneInput.classList.remove("is-valid");
            valid = false;
        } else if (phoneInput.value) {
            phoneInput.classList.remove("is-invalid");
            phoneInput.classList.add("is-valid");
        }

        if (emailInput.value && !emailInput.checkValidity()) {
            emailInput.classList.add("is-invalid");
            emailInput.classList.remove("is-valid");
            valid = false;
        }

        const birthdayVal = birthdayInput.value;
        if (birthdayVal) {
            const maxDate = new Date(birthdayInput.getAttribute('max'));
            const birthDate = new Date(birthdayVal);
            if (birthDate > maxDate) {
                birthdayInput.classList.add("is-invalid");
                birthdayInput.classList.remove("is-valid");
                valid = false;
            } else {
                birthdayInput.classList.remove("is-invalid");
                birthdayInput.classList.add("is-valid");
            }
        }

        const pwd = password.value;
        const confirmPwd = passwordConfirm.value;

        if (pwd) {
            const strength = getPasswordStrength(pwd);
            strengthIndicator.textContent = "Надёжность: " + strength.level;
            strengthIndicator.className = `fw-bold ${strength.class}`;
        }

        if (pwd && confirmPwd && pwd !== confirmPwd) {
            matchMessage.textContent = "Пароли не совпадают";
            matchMessage.className = "fw-bold text-danger";
            matchMessage.style.display = "block";
            passwordConfirm.classList.add("is-invalid");
            passwordConfirm.classList.remove("is-valid");
            submitBtn.disabled = true;
            valid = false;
        } else if (pwd && confirmPwd && pwd === confirmPwd) {
            matchMessage.textContent = "Пароли совпадают";
            matchMessage.className = "fw-bold text-success";
            matchMessage.style.display = "block";
            passwordConfirm.classList.remove("is-invalid");
            passwordConfirm.classList.add("is-valid");
            submitBtn.disabled = false;
        } else {
            matchMessage.style.display = "none";
            passwordConfirm.classList.remove("is-valid", "is-invalid");
            if (!pwd || !confirmPwd) {
                submitBtn.disabled = true;
            }
        }

        return valid;
    }

    password.addEventListener('input', validateFormFields);
    passwordConfirm.addEventListener('input', validateFormFields);
    phoneInput.addEventListener('input', validateFormFields);
    emailInput.addEventListener('input', validateFormFields);
    birthdayInput.addEventListener('input', validateFormFields);

    form.addEventListener('submit', function (e) {
        if (!validateFormFields()) {
            e.preventDefault();
        }
    });

    let checkTimeout = null;
    emailInput.addEventListener("input", () => {
        const username = emailInput.value.trim();
        emailInput.classList.remove("is-invalid", "is-valid");
        usernameFeedback.textContent = "";
        usernameFeedback.classList.remove("text-success", "text-danger");

        clearTimeout(checkTimeout);

        if (username.length < 5) return;

        checkTimeout = setTimeout(() => {
            fetch(`/visitor/check-username?username=${encodeURIComponent(username)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        emailInput.classList.add("is-invalid");
                        usernameFeedback.textContent = "Этот email уже используется";
                        usernameFeedback.classList.add("text-danger");
                    } else {
                        emailInput.classList.add("is-valid");
                        usernameFeedback.textContent = "Email доступен";
                        usernameFeedback.classList.add("text-success");
                    }
                })
                .catch(err => {
                    console.error("Ошибка при проверке email:", err);
                });
        }, 500);
    });
</script>
</body>
</html>