<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Регистрация пользователя</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">

    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/javascript.js"></script>
</head>
<body class="text-center body-signin">
<main class="form-signin">
    <div class="container mt-5 mb-5">
        <form action="/visitor/registration" method="post" id="registrationForm">
            <img class="mb-4" src="/images/logo%20—%20копия.png" alt="" width="200" height="200">
            <h1 class="h3 mb-3 fw-normal">Регистрация пользователя</h1>

            <!-- Адаптивный вывод ошибок -->
            <div th:if="${usernameError}" class="alert alert-danger" th:text="${usernameError}"></div>
            <div th:if="${passwordError}" class="alert alert-danger" th:text="${passwordError}"></div>
            <div th:if="${birthdayError}" class="alert alert-danger" th:text="${birthdayError}"></div>

            <div class="row g-3">
                <div class="col-sm-6">
                    <input type="text" class="form-control" name="inputLastName" id="inputLastName" required placeholder="Фамилия">
                </div>
                <div class="col-sm-6">
                    <input type="text" class="form-control" name="inputFirstName" id="inputFirstName" required placeholder="Имя">
                </div>
                <div class="col-sm-12">
                    <input type="text" class="form-control" name="inputPatronymicName" id="inputPatronymicName" required placeholder="Отчество">
                </div>
                <div class="col-sm-6">
                    <select class="form-select" name="inputSex" id="inputSex" required>
                        <option selected disabled value="">Пол</option>
                        <option value="Мужской">Муж.</option>
                        <option value="Женский">Жен.</option>
                    </select>
                </div>
                <div class="col-sm-6">
                    <input type="date" name="birthday" id="birthday" class="form-control" required th:max="${maxDate}">
                </div>
                <div class="col-sm-6 mx-auto">
                    <input type="tel" name="inputMobileNumber" id="inputMobileNumber"
                           placeholder="Номер телефона" pattern="(\+7|8)\d{10}"
                           class="form-control"
                           title="Введите номер телефона в формате +7XXXXXXXXXX или 8XXXXXXXXXX"
                           required>
                </div>
            </div>

            <br>

            <input type="email" name="username" id="username"
                   placeholder="Введите адрес электронной почты"
                   class="form-control" required><br>

            <input type="password" name="password" id="password"
                   placeholder="Введите пароль" class="form-control"
                   required><br>

            <div class="text-start mb-2">
                <small id="strengthIndicator" class="fw-bold text-muted"></small>
            </div>

            <input type="password" name="passwordConfirm" id="passwordConfirm"
                   placeholder="Подтвердите пароль" class="form-control" required><br>

            <div class="text-start mb-3">
                <small id="matchMessage" class="fw-bold text-danger" style="display: none;"></small>
            </div>

            <div class="form-check text-start mb-3">
                <input type="checkbox" class="form-check-input" id="togglePassword">
                <label class="form-check-label" for="togglePassword">Показать пароли</label>
            </div>

            <button type="submit" class="w-100 btn btn-lg btn-primary" id="submitBtn">Зарегистрироваться</button>

            <div class="mt-3">
                <a class="text-dark" href="/">На главную</a>
            </div>

        </form>
    </div>
</main>

<script>
    const form = document.getElementById('registrationForm');
    const phoneInput = document.getElementById('inputMobileNumber');
    const birthdayInput = document.getElementById('birthday');
    const emailInput = document.getElementById('username');
    const password = document.getElementById('password');
    const passwordConfirm = document.getElementById('passwordConfirm');
    const strengthIndicator = document.getElementById('strengthIndicator');
    const matchMessage = document.getElementById('matchMessage');
    const submitBtn = document.getElementById('submitBtn');
    const togglePassword = document.getElementById('togglePassword');

    // Показать / скрыть пароли
    togglePassword.addEventListener('change', () => {
        const type = togglePassword.checked ? 'text' : 'password';
        password.type = type;
        passwordConfirm.type = type;
    });

    function getPasswordStrength(pwd) {
        if (pwd.length < 6) return { level: "Слабый", class: "text-danger" };
        if (pwd.match(/[A-Z]/) && pwd.match(/[a-z]/) && pwd.match(/[0-9]/) && pwd.length >= 8)
            return { level: "Сильный", class: "text-success" };
        return { level: "Средний", class: "text-warning" };
    }

    function validateFormFields() {
        let valid = true;

        // Телефон
        if (!/^(\+7|8)\d{10}$/.test(phoneInput.value)) {
            phoneInput.classList.add("is-invalid");
            valid = false;
        } else {
            phoneInput.classList.remove("is-invalid");
            phoneInput.classList.add("is-valid");
        }

        // Email
        if (!emailInput.checkValidity()) {
            emailInput.classList.add("is-invalid");
            valid = false;
        } else {
            emailInput.classList.remove("is-invalid");
            emailInput.classList.add("is-valid");
        }

        // Дата
        const birthdayVal = birthdayInput.value;
        if (!birthdayVal) {
            birthdayInput.classList.remove("is-valid", "is-invalid");
        } else {
            const maxDate = new Date(birthdayInput.getAttribute('max'));
            const birthDate = new Date(birthdayVal);
            if (birthDate > maxDate) {
                birthdayInput.classList.add("is-invalid");
                birthdayInput.classList.remove("is-valid");
                valid = false;
            } else {
                birthdayInput.classList.remove("is-invalid");
                birthdayInput.classList.add("is-valid");
            }
        }

        // Пароль
        const pwd = password.value;
        const confirmPwd = passwordConfirm.value;

        const strength = getPasswordStrength(pwd);
        strengthIndicator.textContent = "Надёжность пароля: " + strength.level;
        strengthIndicator.className = `fw-bold ${strength.class}`;

        if (pwd && confirmPwd && pwd !== confirmPwd) {
            matchMessage.textContent = "Пароли не совпадают";
            matchMessage.style.display = "block";
            passwordConfirm.classList.add("is-invalid");
            submitBtn.disabled = true;
            valid = false;
        } else if (pwd && confirmPwd) {
            matchMessage.textContent = "Пароли совпадают";
            matchMessage.classList.remove("text-danger");
            matchMessage.classList.add("text-success");
            matchMessage.style.display = "block";
            passwordConfirm.classList.remove("is-invalid");
            passwordConfirm.classList.add("is-valid");
            submitBtn.disabled = false;
        } else {
            matchMessage.style.display = "none";
            passwordConfirm.classList.remove("is-valid", "is-invalid");
            submitBtn.disabled = true;
            valid = false;
        }

        return valid;
    }

    password.addEventListener('input', validateFormFields);
    passwordConfirm.addEventListener('input', validateFormFields);
    phoneInput.addEventListener('input', validateFormFields);
    emailInput.addEventListener('input', validateFormFields);
    birthdayInput.addEventListener('input', validateFormFields);

    form.addEventListener('submit', function (e) {
        if (!validateFormFields()) {
            e.preventDefault();
        }
    });


    const usernameFeedback = document.createElement("small");
    usernameFeedback.classList.add("fw-bold");
    usernameInput = document.getElementById('username');
    usernameInput.insertAdjacentElement("afterend", usernameFeedback);

    let checkTimeout = null;

    usernameInput.addEventListener("input", () => {
        const username = usernameInput.value.trim();
        usernameInput.classList.remove("is-invalid", "is-valid");
        usernameFeedback.textContent = "";
        usernameFeedback.classList.remove("text-success", "text-danger");

        clearTimeout(checkTimeout);

        if (username.length < 5) return; // проверяем только если более 5 символов

        checkTimeout = setTimeout(() => {
            fetch(`/visitor/check-username?username=${encodeURIComponent(username)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        usernameInput.classList.add("is-invalid");
                        usernameFeedback.textContent = "Этот email уже используется";
                        usernameFeedback.classList.add("text-danger");
                    } else {
                        usernameInput.classList.add("is-valid");
                        usernameFeedback.textContent = "Email доступен";
                        usernameFeedback.classList.add("text-success");
                    }
                })
                .catch(err => {
                    console.error("Ошибка при проверке email:", err);
                });
        }, 500); // отложенный запрос на 0.5 сек
    });
</script>
</body>
</html>
