<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Создание заявки | СИАРСП</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/select2.min.css" />
    <link rel="stylesheet" href="/css/select2-bootstrap-5-theme.min.css" />
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/select2.min.js"></script>
</head>
<body class="admin-page">
<header th:insert="~{blocks/header :: header}"></header>

<div class="container my-5">
    <div class="profile-card mb-4">
        <div class="profile-actions">
            <a th:href="'/employee/warehouseManager/requestsForDelivery/allRequestsForDelivery'" class="btn btn-secondary btn-profile">← Назад к списку</a>
        </div>
    </div>

    <div th:if="${requestError}" class="alert alert-danger" th:text="${requestError}"></div>

    <div class="profile-card p-4">
        <h2 class="h3 mb-4 fw-bold">Создание заявки на поставку</h2>

        <form method="post" th:action="@{/employee/warehouseManager/requestsForDelivery/addRequestForDelivery}">
            <div class="mb-3">
                <label for="supplierId" class="form-label fw-semibold">Поставщик</label>
                <select id="supplierId" name="supplierId" class="form-select" required>
                    <option value="" disabled selected>Выберите поставщика</option>
                    <option th:each="supplier : ${allSuppliers}"
                            th:value="${supplier.getId()}"
                            th:text="${supplier.getName()}"></option>
                </select>
            </div>

            <div class="mb-3">
                <label for="warehouseId" class="form-label fw-semibold">Склад-получатель</label>
                <select id="warehouseId" name="warehouseId" class="form-select" required>
                    <option value="" disabled selected>Выберите склад</option>
                    <option th:each="warehouse : ${allWarehouses}"
                            th:value="${warehouse.getId()}"
                            th:text="${warehouse.getName() + ' (' + warehouse.getAddress() + ')'}"></option>
                </select>
            </div>

            <div class="mb-3">
                <label for="deliveryCost" class="form-label fw-semibold">Стоимость доставки (руб.)</label>
                <input type="number" id="deliveryCost" name="deliveryCost" class="form-control" step="0.01" min="0" value="0" required>
            </div>

            <div class="mb-3">
                <label class="form-label fw-semibold">Товары</label>
                <div id="productRows"></div>
                <button type="button" class="btn btn-sm btn-outline-success mt-2" onclick="addProductRow()">
                    <i class="bi bi-plus-circle"></i> Добавить товар
                </button>
            </div>

            <template id="productTemplate">
                <div class="row g-2 mb-2 product-row">
                    <div class="col-md-5">
                        <select name="productIds" class="form-select product-select" required>
                            <option value="">Поиск товара...</option>
                            <option th:each="product : ${allProducts}"
                                    th:value="${product.getId()}"
                                    th:text="${product.getName() + ' (' + product.getArticle() + ')'}"></option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="number" name="quantities" class="form-control" placeholder="Кол-во" min="1" value="1" required>
                    </div>
                    <div class="col-md-3">
                        <input type="number" name="purchasePrices" class="form-control" placeholder="Цена за ед." step="0.01" min="0" value="0" required>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeProductRow(this)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </template>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary">Создать заявку</button>
            </div>
        </form>
    </div>
</div>

<div th:insert="~{blocks/footer :: footer}"></div>

<script>
    function initSelect2(selectElement) {
        $(selectElement).select2({
            theme: 'bootstrap-5',
            placeholder: 'Поиск товара...',
            allowClear: false,
            width: '100%'
        }).on('change', function() {
            updateProductOptions();
        });
    }

    function addProductRow(productId, quantity, price) {
        var template = document.getElementById('productTemplate');
        var clone = template.content.cloneNode(true);
        if (quantity) {
            var input = clone.querySelector('input[name="quantities"]');
            input.value = quantity;
        }
        if (price) {
            var priceInput = clone.querySelector('input[name="purchasePrices"]');
            priceInput.value = price;
        }
        document.getElementById('productRows').appendChild(clone);

        // Найти только что добавленный select (последний в списке)
        var rows = document.querySelectorAll('.product-row');
        var lastRow = rows[rows.length - 1];
        var select = lastRow.querySelector('select.product-select');

        initSelect2(select);

        if (productId) {
            $(select).val(productId).trigger('change');
        }

        updateProductOptions();
    }

    function removeProductRow(btn) {
        var rows = document.querySelectorAll('.product-row');
        if (rows.length > 1) {
            var row = btn.closest('.product-row');
            var select = row.querySelector('select.product-select');
            $(select).select2('destroy');
            row.remove();
            updateProductOptions();
        }
    }

    function updateProductOptions() {
        var rows = document.querySelectorAll('.product-row');
        var selectedValues = [];

        // Собираем все выбранные значения
        rows.forEach(function(row) {
            var select = row.querySelector('select.product-select');
            var val = $(select).val();
            if (val) {
                selectedValues.push(val);
            }
        });

        // В каждом select скрываем уже выбранные в других строках
        rows.forEach(function(row) {
            var select = row.querySelector('select.product-select');
            var currentVal = $(select).val();

            $(select).find('option').each(function() {
                var optVal = $(this).val();
                if (optVal && optVal !== currentVal && selectedValues.indexOf(optVal) !== -1) {
                    $(this).prop('disabled', true);
                } else {
                    $(this).prop('disabled', false);
                }
            });

            // Обновить Select2, чтобы отобразить disabled-состояние
            // Без пересоздания — достаточно закрыть и открыть
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        addProductRow();
    });
</script>
</body>
</html>
