package com.mai.siarsp.models;

import com.mai.siarsp.enumeration.RoutePointType;
import jakarta.persistence.*;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.ToString;

import java.time.LocalDateTime;
import java.util.ArrayList;

/**
 * Контрольная точка маршрута доставки
 *
 * Представляет одну точку на маршруте доставки товара клиенту.
 * Содержит GPS координаты, адрес, тип точки и информацию о прохождении.
 * Используется водителем-экспедитором через мобильное приложение для навигации и контроля.
 *
 * Согласно ТЗ, водитель фиксирует маршрут:
 * - Пройденные улицы и дома
 * - Километраж поездки
 * - Контрольные точки с временем прохождения
 *
 * Типы точек маршрута (см. RoutePointType enum):
 * 1. WAREHOUSE - точка отправления (склад ИП "Левчук")
 * 2. CHECKPOINT - промежуточная контрольная точка для контроля маршрута
 * 3. DELIVERY_ADDRESS - точка доставки (адрес клиента - конечная точка)
 *
 * Бизнес-процесс использования:
 * 1. Заведующий складом создает задачу на доставку (DeliveryTask)
 * 2. Формирует маршрут, добавляя контрольные точки (RoutePoint) в порядке следования  <--- нет, это делает Директор на этапе формирования ClientOrder
 * 3. Водитель в мобильном приложении видит карту с точками маршрута
 * 4. Приложение автоматически отслеживает геолокацию каждые 5 минут
 * 5. При приближении к точке (< 100 метров) автоматически отмечает как пройденную
 * 6. Водитель может вручную подтвердить прохождение точки
 * 7. При завершении доставки все точки должны быть пройдены (isReached = true)
 *
 * Используется для:
 * - Навигации водителя по оптимальному маршруту
 * - Контроля прохождения маршрута (отклонения от плана)
 * - Расчета фактического времени в пути
 * - Анализа эффективности маршрутов
 * - Выявления задержек и проблемных участков
 * - Отчетности по выполнению доставок
 *
 * Связи:
 * - Принадлежит одной задаче на доставку (DeliveryTask)
 */
@Data
@NoArgsConstructor
@Entity
@Table(name = "t_routePoint",
        uniqueConstraints = @UniqueConstraint(columnNames = {"delivery_task_id", "order_index"}))
@EqualsAndHashCode(of = "id")
public class RoutePoint {

    // ========== ПОЛЯ ==========
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * Порядковый номер точки в маршруте
     * Определяет последовательность прохождения точек
     *
     * Нумерация начинается с 0:
     * - 0 - склад (точка отправления, WAREHOUSE)
     * - 1 - первая промежуточная точка (CHECKPOINT)
     * - 2 - вторая промежуточная точка (CHECKPOINT)
     * - ...
     * - N - адрес доставки клиента (конечная точка, DELIVERY_ADDRESS)
     *
     * Пример маршрута:
     * [0] Склад: ул. Гагарина, 10
     * [1] Контрольная точка: ул. Ленина, 25
     * [2] Адрес доставки: ул. Королёва, 15, МБДОУ №5
     *
     * Используется для:
     * - Отображения точек на карте в правильном порядке
     * - Построения оптимального маршрута
     * - Проверки последовательности прохождения точек
     * - Расчета расстояния между точками
     */
    @Column(nullable = false)
    private int orderIndex;

    /**
     * Тип контрольной точки
     *
     * Возможные типы (см. RoutePointType enum):
     * - WAREHOUSE - склад (точка отправления, orderIndex обычно = 0)
     * - CHECKPOINT - промежуточная контрольная точка
     * - DELIVERY_ADDRESS - адрес доставки клиента (конечная точка)
     *
     * Используется для:
     * - Разного отображения точек на карте (цвета маркеров, иконки)
     * - Бизнес-логики (например, обязательность прохождения)
     * - Формирования отчетов по маршруту
     * - Определения начала и конца маршрута
     *
     * Правила:
     * - WAREHOUSE должна быть первой точкой (orderIndex = 0)
     * - DELIVERY_ADDRESS должна быть последней точкой
     * - CHECKPOINT используются для промежуточного контроля
     */
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private RoutePointType pointType;

    /**
     * Широта GPS координаты точки
     * Географическая широта в десятичных градусах
     *
     * Диапазон: -90.0 (южный полюс) до +90.0 (северный полюс)
     * - Положительные значения - северная широта
     * - Отрицательные значения - южная широта
     *
     * Примеры для г. Байконур:
     * - Склад на ул. Гагарина: 45.9653
     * - Детский сад на ул. Королёва: 45.9621
     *
     * Используется для:
     * - Отображения точки на карте (Google Maps, Yandex Maps)
     * - Расчета расстояния между точками
     * - Определения факта достижения точки (геозона радиусом 100м)
     * - Построения оптимального маршрута
     */
    @Column(nullable = false)
    private Double latitude;

    /**
     * Долгота GPS координаты точки
     * Географическая долгота в десятичных градусах
     *
     * Диапазон: -180.0 (запад) до +180.0 (восток)
     * - Положительные значения - восточная долгота
     * - Отрицательные значения - западная долгота
     *
     * Примеры для г. Байконур:
     * - Склад на ул. Гагарина: 63.3050
     * - Детский сад на ул. Королёва: 63.3102
     *
     * Используется совместно с latitude для точного позиционирования
     *
     * Пара (latitude, longitude) однозначно определяет любую точку на Земле
     */
    @Column(nullable = false)
    private Double longitude;

    /**
     * Адрес контрольной точки в текстовом виде
     * Человекочитаемый адрес для водителя
     *
     * Примеры:
     * - "г. Байконур, ул. Гагарина, д. 10" (склад)
     * - "г. Байконур, ул. Ленина, д. 25" (промежуточная точка)
     * - "г. Байконур, ул. Королёва, д. 15, МБДОУ Детский сад №5" (адрес клиента)
     *
     * Для конечной точки (DELIVERY_ADDRESS) рекомендуется указывать:
     * - Полный адрес с названием улицы, номером дома
     * - Название организации-клиента
     * - Дополнительные ориентиры (подъезд, этаж, особенности подъезда)
     *
     * Используется для:
     * - Отображения в мобильном приложении водителя
     * - Навигации (водитель видит куда ехать)
     * - Подтверждения прибытия (сверка с фактическим местоположением)
     * - Формирования путевых документов
     */
    @Column(nullable = false, length = 500)
    private String address;

    /**
     * Планируемое время прибытия в точку
     * Расчетное время, когда водитель должен прибыть в эту точку
     *
     * Рассчитывается заведующим складом на основе:
     * - Времени начала доставки (DeliveryTask.plannedStartTime)
     * - Расстояния между точками
     * - Средней скорости движения (например, 40 км/ч в городе)
     * - Времени на погрузку товара на складе
     * - Времени на разгрузку у клиента
     *
     * Пример расчета:
     * - Начало доставки: 09:00
     * - Расстояние от склада до точки: 5 км
     * - Средняя скорость: 30 км/ч
     * - Время в пути: 10 минут
     * - Планируемое прибытие: 09:10
     *
     * Используется для:
     * - Планирования времени доставки
     * - Информирования клиента о времени прибытия
     * - Выявления отклонений от графика (опоздания/опережения)
     * - Оптимизации маршрутов
     *
     * null - время не рассчитано (например, для промежуточных точек)
     */
    @Column
    private LocalDateTime plannedArrivalTime;

    /**
     * Фактическое время прибытия в точку
     * Реальное время, когда водитель достиг точки
     *
     * Фиксируется автоматически при:
     * - Автоматическом определении достижения точки (геолокация < 100м от точки)
     * - Ручном подтверждении водителем в мобильном приложении
     *
     * Используется для:
     * - Контроля выполнения графика доставки
     * - Расчета фактического времени в пути
     * - Анализа эффективности маршрутов
     * - Выявления проблемных участков (пробки, задержки)
     * - Сравнения с планируемым временем прибытия
     * - Формирования отчетов по выполнению доставок
     *
     * Пример анализа:
     * - Планируемое прибытие: 09:10
     * - Фактическое прибытие: 09:25
     * - Задержка: 15 минут (возможная причина - пробка)
     *
     * null - точка еще не достигнута
     */
    @Column
    private LocalDateTime actualArrivalTime;

    /**
     * Признак достижения точки
     * Флаг, указывающий прошел ли водитель эту контрольную точку
     *
     * true - точка пройдена (водитель прибыл в эту точку)
     * false - точка еще не достигнута (водитель в пути)
     *
     * Устанавливается в true при:
     * - Автоматическом определении геолокации водителя в радиусе 100м от точки
     * - Ручном подтверждении водителем через кнопку "Отметить прибытие" в приложении
     *
     * Одновременно с установкой isReached = true фиксируется actualArrivalTime
     *
     * Используется для:
     * - Отображения прогресса доставки на карте
     *   (пройденные точки - зеленые, текущая - желтая, будущие - серые)
     * - Контроля соблюдения маршрута водителем
     * - Проверки завершения доставки (все точки должны быть пройдены)
     * - Уведомлений заведующему складом о ходе доставки
     * - Блокировки завершения задачи до прохождения всех точек
     *
     * Бизнес-правило:
     * Водитель не может завершить задачу доставки (DeliveryTask),
     * пока все точки маршрута не будут отмечены как пройденные (isReached = true)
     */
    @Column(nullable = false)
    private boolean isReached;

    /**
     * Комментарий к контрольной точке
     * Дополнительная информация или примечания
     *
     * Может содержать:
     * - Инструкции для водителя (от заведующего при создании маршрута)
     * - Примечания водителя о прохождении точки
     * - Описание проблем или задержек
     * - Особенности доставки в данную точку
     *
     * Примеры:
     * - "Въезд с торца здания, шлагбаум слева"
     * - "Позвонить за 10 минут до прибытия по телефону 8-XXX-XXX-XX-XX"
     * - "Разгрузка на складе, 2 этаж, есть грузовой лифт"
     * - "Задержка 15 минут из-за пробки на ул. Ленина" (добавлено водителем)
     * - "Клиент просил не позднее 10:00" (добавлено заведующим)
     *
     * Используется для:
     * - Передачи важной информации водителю
     * - Фиксации проблем и особенностей при доставке
     * - Накопления опыта для оптимизации будущих маршрутов
     * - Анализа причин задержек
     *
     * null или пустая строка - комментариев нет
     */
    @Column(length = 500)
    private String comment;

    /**
     * Задача на доставку, к которой относится точка
     * Одна точка принадлежит только одной задаче доставки
     *
     * Связь с DeliveryTask, который содержит:
     * - Заказ клиента (с товарами и адресом)
     * - Водителя, выполняющего доставку
     * - Автомобиль, используемый для доставки
     * - Все точки маршрута (включая данную)
     * - Статус выполнения доставки
     * - Пробег автомобиля (начальный и конечный)
     *
     * Используется для:
     * - Получения полной информации о доставке
     * - Доступа к другим точкам маршрута
     * - Проверки статуса задачи
     */
    @ToString.Exclude
    @ManyToOne
    @JoinColumn(nullable = false)
    private DeliveryTask deliveryTask;

    // ========== КОНСТРУКТОРЫ ==========

    /**
     * Создает новую контрольную точку маршрута
     * Автоматически устанавливает isReached = false (точка еще не достигнута)
     *
     * @param orderIndex порядковый номер точки в маршруте (0 для склада, 1, 2, ... для остальных)
     * @param pointType тип точки (WAREHOUSE, CHECKPOINT, DELIVERY_ADDRESS)
     * @param latitude широта GPS координаты в десятичных градусах
     * @param longitude долгота GPS координаты в десятичных градусах
     * @param address текстовый адрес точки для отображения водителю
     */
    public RoutePoint(int orderIndex, RoutePointType pointType,
                      Double latitude, Double longitude, String address) {
        this.orderIndex = orderIndex;
        this.pointType = pointType;
        this.latitude = latitude;
        this.longitude = longitude;
        this.address = address;
        this.isReached = false;
    }

    // ========== МЕТОДЫ ==========

    /**
     * Возвращает GPS координаты в читаемом формате
     * Форматирует широту и долготу для отображения или копирования
     *
     * Формат: "широта, долгота" с точностью до 6 знаков после запятой
     *
     * Примеры:
     * - "45.965000, 63.305000" (склад в Байконуре)
     * - "45.962100, 63.310200" (детский сад в Байконуре)
     *
     * Используется для:
     * - Отображения координат в интерфейсе
     * - Копирования в навигатор (Яндекс.Навигатор, Google Maps)
     * - Логирования и отладки
     * - Передачи координат в API картографических сервисов
     *
     * @return строка вида "45.965000, 63.305000"
     */
    @Transient
    public String getCoordinates() {
        return String.format("%.6f, %.6f", latitude, longitude);
    }
}