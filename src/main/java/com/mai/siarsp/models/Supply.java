package com.mai.siarsp.models;

import jakarta.persistence.*;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.ToString;

import java.math.BigDecimal;

/**
 * Позиция в поставке товара (конкретный товар в составе поставки)
 *
 * Представляет один товар в составе поставки от поставщика (Delivery).
 * Содержит информацию о товаре, фактически полученном количестве и закупочной цене.
 *
 * Отличие от RequestedProduct:
 * - RequestedProduct - что ЗАКАЗАЛИ у поставщика (план, заявка)
 * - Supply - что ПОЛУЧИЛИ от поставщика (факт, поставка)
 *
 * Бизнес-процесс:
 * 1. Заведующий создает заявку (RequestForDelivery) с позициями (RequestedProduct)
 * 2. Заявка проходит согласование и отправляется поставщику
 * 3. Поставщик привозит товар
 * 4. Заведующий принимает товар, проверяет по накладной (ТЗ п.83-89)
 * 5. Создается поставка (Delivery) с фактическими позициями (Supply)
 * 6. Сопоставление: RequestedProduct vs Supply
 * 7. Если есть расхождения (недопоставка, брак) - оформляется акт  <-- нет, не оформляется, это не реализовываю.
 *
 * Примеры сопоставления:
 *
 * Случай 1 - Все ОК:
 * RequestedProduct: Молоко 3.2% - 200 шт.
 * Supply: Молоко 3.2% - 200 шт., цена 45 руб. ✓
 *
 * Случай 2 - Недопоставка:
 * RequestedProduct: Сметана 20% - 100 шт.
 * Supply: Сметана 20% - 95 шт., цена 60 руб. ⚠
 * Недопоставка: 5 шт. (может быть указано в комментарии к Delivery)
 *
 * Случай 3 - Брак:
 * RequestedProduct: Творог 9% - 150 шт.
 * Supply: Творог 9% - 150 шт., цена 55 руб.
 * При приемке обнаружено: 10 шт. с браком
 * Создается ReturnAct на возврат 10 шт. поставщику
 *
 * Связи:
 * - Принадлежит одной поставке (Delivery)
 * - Ссылается на один товар (Product)
 */
@Data
@NoArgsConstructor
@Entity
@Table(name = "t_supply")
@EqualsAndHashCode(of = "id")
public class Supply {

    // ========== ПОЛЯ ==========
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * Закупочная цена за единицу товара (в рублях)
     * Цена, по которой ИП "Левчук" покупает товар у поставщика
     *
     * Особенности:
     * - Указывается цена на момент конкретной поставки
     * - Может меняться от поставки к поставке (сезонность, инфляция)
     * - Используется для расчета себестоимости товара
     * - Влияет на формирование розничной цены для клиентов
     *
     * Примеры:
     * - Молоко 3.2% 1л: закупочная цена 45 руб., продажная 60 руб. (наценка 33%)
     * - Хлеб белый 400г: закупочная цена 25 руб., продажная 35 руб. (наценка 40%)
     * - Яблоки 1 кг: закупочная цена 80 руб., продажная 120 руб. (наценка 50%)
     *
     * Используется для:
     * - Расчета общей стоимости поставки
     * - Анализа динамики закупочных цен
     * - Выбора оптимального поставщика (сравнение цен)
     * - Расчета рентабельности товара
     * - Формирования себестоимости для финансовой отчетности
     * - Бухгалтерского учета (ТЗ п.250-260)
     *
     * Согласно ТЗ п.259, бухгалтер осуществляет оплату за закупленный товар
     * на основе этой цены и количества
     */
    @Column(nullable = false, precision = 10, scale = 2)
    private BigDecimal purchasePrice;

    /**
     * Фактически полученное количество товара
     * Количество единиц товара, которое реально привез поставщик
     *
     * Сопоставление с заявкой:
     * - Если quantity (Supply) = quantity (RequestedProduct) → поставка полная ✓
     * - Если quantity (Supply) < quantity (RequestedProduct) → недопоставка ⚠
     * - Если quantity (Supply) > quantity (RequestedProduct) → пересорт (редко)
     *
     * Примеры ситуаций:
     *
     * 1. Полная поставка:
     *    Заказали: 200 шт.
     *    Привезли: 200 шт.
     *    Оприходовано: 200 шт. → Product.stockQuantity += 200
     *
     * 2. Недопоставка:
     *    Заказали: 200 шт.
     *    Привезли: 195 шт.
     *    Оприходовано: 195 шт. → Product.stockQuantity += 195
     *    Статус заявки: PARTIALLY_RECEIVED
     *
     * 3. Брак при приемке:
     *    Заказали: 200 шт.
     *    Привезли: 200 шт.
     *    Обнаружен брак: 10 шт.
     *    Оприходовано: 190 шт. → Product.stockQuantity += 190
     *    Создан ReturnAct на возврат 10 шт. поставщику
     *
     * Используется для:
     * - Оприходования товара на склад (увеличение Product.stockQuantity)
     * - Расчета общей стоимости поставки
     * - Сопоставления с заявкой (контроль выполнения)
     * - Выявления недопоставок
     * - Формирования актов возврата при браке
     * - Статистики по поставщикам
     *
     * Согласно ТЗ п.83-89, заведующий складом принимает товар и проверяет
     * соответствие фактического количества заявленному
     */
    @Column(nullable = false)
    private int quantity;

    /**
     * Товар, который поставлен
     * Ссылка на справочник товаров
     *
     * Содержит информацию о:
     * - Наименовании и артикуле товара
     * - Категории товара
     * - Текущем остатке на складе (до и после оприходования)
     * - Истории поставок данного товара
     * - Требованиях к хранению (обычный склад/холодильник)
     *
     * После приемки товара:
     * - Product.stockQuantity увеличивается на quantity
     * - Product.quantityForStock увеличивается на quantity
     *   (товар оприходован, но еще не размещен на полках)
     * - Товар готов к размещению на складе
     *
     * Используется для:
     * - Идентификации полученного товара
     * - Оприходования на склад
     * - Сопоставления с заявкой (проверка соответствия товара)
     * - Анализа ассортимента поставок
     * - Связи с категорией и атрибутами товара
     */
    @ToString.Exclude
    @ManyToOne
    @JoinColumn(nullable = false)
    private Product product;

    /**
     * Поставка, к которой относится позиция
     * Одна позиция принадлежит только одной поставке
     *
     * Связь с документом поставки, который содержит:
     * - Дату поставки
     * - Поставщика, от которого получен товар
     * - Все позиции товаров в поставке
     * - Связь с заявкой (если поставка была по заявке)
     *
     * Используется для:
     * - Группировки товаров по поставкам
     * - Получения информации о поставщике
     * - Расчета общей стоимости поставки
     * - Сопоставления с заявкой
     * - Формирования отчетов по поставкам
     * - Бухгалтерского учета поступления товара
     */
    @ToString.Exclude
    @ManyToOne
    @JoinColumn(nullable = false)
    private Delivery delivery;

    // ========== КОНСТРУКТОРЫ ==========

    /**
     * Создает новую позицию поставки товара
     *
     * @param product товар, который поставлен
     * @param purchasePrice закупочная цена за единицу товара (в рублях)
     * @param quantity фактически полученное количество единиц товара
     */
    public Supply(Product product, BigDecimal purchasePrice, int quantity) {
        this.product = product;
        this.purchasePrice = purchasePrice;
        this.quantity = quantity;
    }

    // ========== МЕТОДЫ ==========

    /**
     * Вычисляет общую стоимость позиции поставки
     *
     * Формула: purchasePrice × quantity
     *
     * Примеры:
     * - Молоко: 45 руб. × 200 шт. = 9 000 руб.
     * - Хлеб: 25 руб. × 150 шт. = 3 750 руб.
     * - Яблоки: 80 руб. × 50 кг = 4 000 руб.
     *
     * Используется для:
     * - Расчета общей суммы поставки (Delivery.getTotalCost())
     * - Формирования счета на оплату поставщику
     * - Бухгалтерского учета расходов на закупку
     * - Контроля бюджета закупок
     * - Анализа структуры затрат на закупку
     *
     * Согласно ТЗ п.259, бухгалтер осуществляет оплату за закупленный товар
     * на основе этой суммы
     *
     * @return общая стоимость позиции в рублях (цена × количество)
     */
    public BigDecimal getTotalPrice() {
        return purchasePrice.multiply(BigDecimal.valueOf(quantity));
    }
}