package com.mai.siarsp.models;

import jakarta.persistence.*;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.ToString;

import java.time.LocalDate;
import java.time.LocalDateTime;

/**
 * Товарно-транспортная накладная (ТТН)
 *
 * Официальный документ, сопровождающий груз при перевозке от склада ИП "Левчuk"
 * до конечного потребителя (детский сад, школа, больница).
 * Подтверждает передачу товара от грузоотправителя грузополучателю.
 *
 * Согласно ТЗ, ТТН составляется и выдается в 2-х экземплярах при
 * перевозке груза автомобильным транспортом. ТТН оформляется бухгалтером
 * и передается водителю-экспедитору для доставки клиенту.
 *
 * Назначение ТТН:
 * - Подтверждение факта передачи груза перевозчику
 * - Фиксация характеристик груза (описание, вес, объем)
 * - Идентификация сторон перевозки (отправитель, получатель, перевозчик)
 * - Юридическая защита при спорах о доставке
 * - Бухгалтерский учет отгрузки товара
 *
 * Состав документа:
 * 1. Номер и дата составления
 * 2. Данные грузоотправителя (ИП "Левчук")
 * 3. Данные грузополучателя (клиент)
 * 4. Данные перевозчика (водитель, автомобиль)
 * 5. Описание груза (наименование, вес, объем)
 * 6. Подписи сторон
 *
 * Workflow:
 * 1. Бухгалтер оформляет ТТН при создании задачи на доставку
 * 2. ТТН передается водителю-экспедитору
 * 3. Водитель везет товар и ТТН клиенту
 * 4. Клиент получает товар, проверяет соответствие ТТН
 * 5. Клиент подписывает ТТН (подтверждение получения)
 * 6. Один экземпляр остается у клиента, второй возвращается в ИП "Левчук"
 * 7. ТТН используется для бухгалтерского учета реализации
 *
 * Связи:
 * - Относится к одной задаче на доставку (DeliveryTask)
 * - Оформляется для одного автомобиля (Vehicle)
 * - Подписывается одним водителем (Employee с ролью DRIVER)
 */
@Data
@NoArgsConstructor
@Entity
@Table(name = "t_ttn")
@EqualsAndHashCode(of = "id")
public class TTN {

    // ========== ПОЛЯ ==========
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * Номер товарно-транспортной накладной
     * Уникальный номер документа для идентификации
     *
     * Формат: обычно ТТН-YYYYMMDD-NNNN
     *
     * Примеры:
     * - "ТТН-20250204-0001"
     * - "ТТН-20250204-0002"
     * - "TTN-2025-000042"
     *
     * Используется для:
     * - Идентификации документа в системе
     * - Ссылок в других документах (акты, счета)
     * - Поиска ТТН в архиве
     * - Сопоставления с бухгалтерскими проводками
     * - Отчетности перед налоговыми органами
     *
     * Уникален в системе для предотвращения дублирования документов
     */
    @Column(nullable = false, unique = true, length = 50)
    private String ttnNumber;

    /**
     * Дата выдачи (составления) ТТН
     * Дата, когда документ был оформлен бухгалтером
     *
     * Обычно совпадает с датой начала доставки, но может быть оформлена
     * заранее (например, накануне для утренней доставки)
     *
     * Используется для:
     * - Хронологического учета документов
     * - Сопоставления с датой фактической доставки
     * - Бухгалтерского учета (дата отгрузки)
     * - Сортировки ТТН в архиве
     * - Отчетности по периодам
     *
     * Автоматически устанавливается на текущую дату при создании
     */
    @Column(nullable = false)
    private LocalDate issueDate;

    /**
     * Описание груза
     * Краткое описание перевозимого товара
     *
     * Примеры:
     * - "Молочная продукция: молоко, сметана, творог"
     * - "Хлебобулочные изделия: хлеб белый, хлеб черный"
     * - "Продукты питания для МБДОУ Детский сад №5"
     * - "Товары по заказу №ЗК-20250204-0042"
     *
     * Может содержать:
     * - Общее описание категорий товара
     * - Ссылку на заказ клиента
     * - Особые отметки (скоропортящийся, хрупкий)
     *
     * Используется для:
     * - Идентификации груза при перевозке
     * - Таможенного контроля (если применимо)
     * - Проверки груза получателем
     * - Страхования груза
     */
    @Column(length = 500)
    private String cargoDescription;

    /**
     * Общий вес груза в килограммах
     * Суммарный вес всех товаров в заказе
     *
     * Примеры:
     * - 250.5 кг (молочная продукция)
     * - 85.0 кг (хлебобулочные изделия)
     * - 320.8 кг (смешанный заказ)
     *
     * Рассчитывается как сумма весов всех позиций заказа:
     * Σ (Product.weight × OrderedProduct.quantity)
     *
     * Используется для:
     * - Контроля загрузки автомобиля (не превысить грузоподъемность)
     * - Расчета стоимости доставки (если зависит от веса)
     * - Проверки груза при приемке
     * - Таможенного оформления (если применимо)
     * - Планирования маршрута (учет нагрузки)
     *
     * null - вес не указан или не рассчитан
     */
    @Column
    private Double totalWeight;

    /**
     * Общий объем груза в кубических метрах
     * Суммарный объем всех товаров в заказе
     *
     * Примеры:
     * - 0.85 м³ (молочная продукция)
     * - 1.2 м³ (хлебобулочные изделия)
     * - 2.5 м³ (смешанный заказ)
     *
     * Рассчитывается на основе габаритов упаковок товаров:
     * Σ (Product.packageLength × Product.packageWidth × Product.packageHeight × OrderedProduct.quantity) / 1_000_000  <----Шта? Этот метод рассчитывает объем, а не массу.
     *
     * Используется для:
     * - Контроля загрузки автомобиля (не превысить объемную вместимость)
     * - Выбора подходящего автомобиля для доставки
     * - Оптимизации загрузки кузова
     * - Планирования размещения товара в автомобиле
     *
     * Согласно ТЗ п.118-120, система учитывает габариты товара,
     * что позволяет рассчитать объем груза
     *
     * null - объем не указан или не рассчитан
     */
    @Column
    private Double totalVolume;

    /**
     * Комментарий к ТТН
     * Дополнительные примечания или особые условия перевозки
     *
     * Примеры:
     * - "Груз скоропортящийся, соблюдать холодовую цепь"
     * - "Разгрузка со стороны склада, 2 этаж"
     * - "Контактное лицо: Иванова М.П., тел. 8-XXX-XXX-XX-XX"
     * - "Доставка до 10:00, срочная"
     *
     * Может содержать:
     * - Особые условия хранения и транспортировки
     * - Инструкции для водителя
     * - Контактную информацию получателя
     * - Примечания о частичной доставке
     * - Информацию о возврате тары
     *
     * null или пустая строка - комментариев нет
     */
    @Column(length = 500)
    private String comment;

    /**
     * Задача на доставку, для которой оформлена ТТН
     * Один ТТН соответствует одной задаче доставки
     *
     * Связь с DeliveryTask, который содержит:
     * - Заказ клиента (ClientOrder) с товарами
     * - Водителя-экспедитора
     * - Автомобиль
     * - Маршрут с контрольными точками
     * - Статус выполнения доставки
     *
     * Используется для:
     * - Получения информации о заказе и товарах
     * - Идентификации грузоотправителя и грузополучателя
     * - Формирования содержимого ТТН
     * - Связи ТТН с актом приема-передачи
     * - Отчетности по доставкам
     */
    @ToString.Exclude
    @OneToOne
    @JoinColumn(nullable = false)
    private DeliveryTask deliveryTask;

    /**
     * Автомобиль, используемый для перевозки
     * Транспортное средство, на котором осуществляется доставка
     *
     * Содержит информацию о:
     * - Регистрационном номере (государственный номер)
     * - Марке и модели автомобиля
     * - Типе (обычный/рефрижератор)
     * - Грузоподъемности и вместимости
     *
     * Используется в ТТН для:
     * - Указания транспортного средства
     * - Идентификации перевозчика
     * - Контроля соответствия типа авто грузу
     *   (рефрижератор для скоропортящихся продуктов)
     * - Отчетности по использованию транспорта
     *
     * Согласно ТЗ, в ТТН указываются данные транспортного средства
     */
    @ToString.Exclude
    @ManyToOne
    @JoinColumn(nullable = false)
    private Vehicle vehicle;

    /**
     * Водитель-экспедитор, осуществляющий доставку
     * Сотрудник с ролью DRIVER, ответственный за перевозку груза
     *
     * Используется в ТТН для:
     * - Указания лица, ответственного за груз
     * - Идентификации перевозчика
     * - Подписи ТТН со стороны перевозчика
     * - Передачи груза получателю
     *
     * ФИО водителя указывается в ТТН:
     * "Водитель-экспедитор: Петров П.П."
     * "Подпись водителя: ___________"
     *
     * Водитель обязан:
     * - Проверить соответствие груза ТТН при погрузке
     * - Обеспечить сохранность груза при перевозке
     * - Передать груз и ТТН получателю
     * - Получить подпись получателя на ТТН
     * - Вернуть один экземпляр ТТН в ИП "Левчук"
     */
    @ToString.Exclude
    @ManyToOne
    @JoinColumn(nullable = false)
    private Employee driver;

    // ========== КОНСТРУКТОРЫ ==========

    /**
     * Создает новую товарно-транспортную накладную
     * Автоматически устанавливает текущую дату как дату выдачи
     *
     * @param ttnNumber уникальный номер ТТН (генерируется сервисом)
     * @param deliveryTask задача на доставку, для которой оформляется ТТН
     * @param vehicle автомобиль, используемый для перевозки
     * @param driver водитель-экспедитор, осуществляющий доставку
     */
    public TTN(String ttnNumber, DeliveryTask deliveryTask, Vehicle vehicle, Employee driver) {
        this.ttnNumber = ttnNumber;
        this.deliveryTask = deliveryTask;
        this.vehicle = vehicle;
        this.driver = driver;
        this.issueDate = LocalDate.now();
    }

    // ========== МЕТОДЫ ==========
    // Специфичных методов нет, используются стандартные getter/setter от Lombok
    //
    // Возможные методы для добавления в сервисный слой:
    // - generateTTNDocument() - формирование печатной формы ТТН
    // - calculateTotalWeight() - расчет веса на основе заказа
    // - calculateTotalVolume() - расчет объема на основе габаритов товара
    // - validateTTN() - проверка корректности заполнения ТТН
    // - printTTN() - печать ТТН в 2-х экземплярах

}