package com.mai.siarsp.models;

import jakarta.persistence.*;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.ToString;

import java.util.ArrayList;
import java.util.List;

/**
 * Зона хранения (полка на стеллаже)
 *
 * Конкретное место на стеллаже, где физически размещается товар.
 * Имеет определенные габариты (длина, ширина, высота) и может содержать
 * несколько товаров с разными ориентациями размещения.
 *
 * Иерархия складского учета:
 * Warehouse (Основной склад)
 *   → Shelf (Стеллаж A)
 *     → StorageZone (Полка A1: 200×80×40 см)
 *       → ZoneProduct (Молоко 3.2% - 50 шт., стоя)
 *       → ZoneProduct (Хлеб - 30 шт., лежа на боку)
 *
 * Назначение:
 * - Физическое размещение товара с учетом габаритов упаковки
 * - Контроль использования пространства (сколько места занято/свободно)
 * - Оптимизация загрузки полки (подбор товаров по размерам)
 * - Расчет доступной емкости для нового товара
 *
 * Согласно ТЗ, система должна:
 * - Подсчитывать оставшееся место на складе
 * - Учитывать габариты товара при размещении
 * - Предупреждать о переполнении склада
 *
 * Примеры полок:
 * - Полка "A1": 200×80×40 см, емкость 640 л, заполнена на 75%
 * - Полка "A2": 200×80×40 см, емкость 640 л, заполнена на 45%
 * - Полка "R1-1": 150×60×50 см, емкость 450 л, заполнена на 90% (холодильник)
 *
 * Связи:
 * - Принадлежит одному стеллажу (Shelf)
 * - Содержит множество товаров с их размещением (ZoneProduct)
 */
@Data
@NoArgsConstructor
@Entity
@Table(name = "t_storageZone")
@EqualsAndHashCode(of = "id")
public class StorageZone {

    // ========== ПОЛЯ ==========
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * Метка (номер) полки для идентификации
     * Обычно состоит из кода стеллажа + порядковый номер полки
     *
     * Примеры:
     * - "A1", "A2", "A3" (полки на стеллаже A)
     * - "B1", "B2", "B3" (полки на стеллаже B)
     * - "R1-1", "R1-2" (полки на стеллаже R1 в холодильнике)
     * - "МОЛ-1-верх", "МОЛ-1-низ" (с дополнительным описанием)
     *
     * Используется для:
     * - Идентификации конкретной полки на складе
     * - Указания местоположения товара (например, "Молоко на полке A2")
     * - Навигации при размещении и комплектации товара
     * - Формирования карты склада
     * - Поиска товара для отгрузки
     *
     * Заведующий складом говорит работнику:
     * "Положи молоко на стеллаж A, полку A2" или "Возьми хлеб с полки B1"
     */
    @Column(nullable = false)
    private String label;

    /**
     * Длина полки в сантиметрах
     * Горизонтальный размер полки вдоль стеллажа
     *
     * Типичные значения:
     * - 150-250 см (стандартные стеллажи для склада)
     * - 100-150 см (компактные стеллажи)
     * - 300+ см (большие промышленные стеллажи)
     *
     * Используется для:
     * - Расчета объема полки (length × width × height)
     * - Определения возможности размещения товара по длине
     * - Оптимизации заполнения полки
     * - Визуализации схемы склада
     */
    @Column(nullable = false)
    private double length;

    /**
     * Ширина полки в сантиметрах
     * Горизонтальный размер полки перпендикулярно длине
     *
     * Типичные значения:
     * - 40-80 см (стандартные стеллажи)
     * - 60-100 см (широкие стеллажи для крупногабаритных товаров)
     *
     * Используется для:
     * - Расчета объема полки
     * - Проверки размещения товара по ширине
     * - Определения максимальной ширины упаковки товара
     */
    @Column(nullable = false)
    private double width;

    /**
     * Высота полки в сантиметрах
     * Вертикальный размер (расстояние от полки до следующей полки или потолка)
     *
     * Типичные значения:
     * - 30-50 см (низкие полки для мелких товаров)
     * - 50-80 см (средние полки для товаров среднего размера)
     * - 100+ см (высокие полки для крупногабаритных товаров или для вертикального размещения)
     *
     * Используется для:
     * - Расчета объема полки
     * - Проверки возможности размещения товара по высоте
     * - Определения максимальной высоты упаковки товара
     * - Учета ориентации размещения (стоя/лежа)
     */
    @Column(nullable = false)
    private double height;

    /**
     * Стеллаж, к которому относится полка
     * Одна полка принадлежит только одному стеллажу
     *
     * Связь с родительской сущностью, через которую определяется:
     * - Склад, на котором находится полка (shelf.warehouse)
     * - Тип склада (обычный/холодильный)
     * - Код стеллажа для формирования метки полки
     *
     * Используется для:
     * - Определения типа товаров, которые можно размещать
     * - Проверки совместимости товара с типом склада
     * - Формирования иерархии: Склад → Стеллаж → Полка
     */
    @ToString.Exclude
    @ManyToOne
    @JoinColumn(nullable = false)
    private Shelf shelf;

    /**
     * Список товаров, размещенных на данной полке
     * Каждая запись (ZoneProduct) содержит:
     * - Товар (Product)
     * - Количество единиц товара
     * - Ориентацию размещения (стоя, лежа на боку, повернут на 90°)
     *
     * Примеры размещения на полке "A1":
     * - Молоко 3.2% 1л - 50 шт. (стоя: 10×10×23 см каждая упаковка)
     * - Хлеб белый 400г - 30 шт. (лежа на боку: 30×12×8 см каждая упаковка)
     *
     * Используется для:
     * - Учета фактического размещения товара
     * - Расчета занятого объема на полке
     * - Определения свободного места
     * - Формирования списка товаров на полке для комплектации
     * - Инвентаризации (сверка фактического наличия с учетным)
     *
     * Согласно ТЗ п.118-120, товары размещаются с учетом их габаритов
     * и ориентации, чтобы оптимально использовать пространство полки
     */
    @ToString.Exclude
    @OneToMany(mappedBy = "zone", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<ZoneProduct> products = new ArrayList<>();

    // ========== КОНСТРУКТОРЫ ==========

    // ========== МЕТОДЫ ==========

    /**
     * Вычисляет объемную емкость полки в литрах
     * Переводит габариты из сантиметров в литры
     *
     * Формула: (length × width × height) / 1_000_000
     *
     * Объяснение:
     * - 1 см³ = 0.001 л
     * - 1_000_000 см³ = 1000 л = 1 м³
     *
     * Примеры:
     * - Полка 200×80×40 см = 640 000 см³ = 640 л
     * - Полка 150×60×50 см = 450 000 см³ = 450 л
     * - Полка 100×40×30 см = 120 000 см³ = 120 л
     *
     * Используется для:
     * - Отображения емкости полки в интерфейсе
     * - Расчета процента заполнения
     * - Определения возможности размещения нового товара
     * - Отчетности по использованию складского пространства
     * - Планирования размещения товара
     *
     * @return объем полки в литрах
     */
    public double getCapacityVolume() {
        return (length * width * height) / 1_000_000.0;
    }

    /**
     * Вычисляет процент заполнения полки
     * Показывает, какая доля полки занята товаром
     *
     * Алгоритм:
     * 1. Суммируется объем всех товаров на полке (ZoneProduct.getTotalVolume())
     * 2. Вычисляется процент от общей емкости полки
     *
     * Формула: (используемый объем / емкость полки) × 100%
     *
     * Примеры:
     * - Полка 640 л, товара 480 л → 75% заполнения
     * - Полка 450 л, товара 405 л → 90% заполнения (близко к переполнению)
     * - Полка 120 л, товара 30 л → 25% заполнения (много свободного места)
     *
     * Используется для:
     * - Визуализации загрузки полки (цветовая индикация: зеленый/желтый/красный)
     * - Предупреждения о переполнении (если > 95%)
     * - Поиска полок с достаточным свободным местом для нового товара
     * - Оптимизации использования складского пространства
     * - Отчетности по эффективности использования склада
     *
     * Согласно ТЗ п.118-120, система должна предупреждать о переполнении,
     * для чего необходим расчет процента заполнения
     *
     * @return процент заполнения от 0.0 до 100.0, или 0.0 если полка пуста
     */
    public double getOccupancyPercentage() {
        if (products == null || products.isEmpty()) {
            return 0.0;
        }

        double used = products.stream()
                .mapToDouble(ZoneProduct::getTotalVolume)
                .sum();
        double capacity = getCapacityVolume();

        return capacity > 0 ? (used / capacity) * 100.0 : 0.0;
    }

    /**
     * Проверяет возможность размещения товара на данной полке
     * Проверяет совместимость типа товара с типом склада
     *
     * Бизнес-правило:
     * - Товары с warehouseType = REFRIGERATED можно размещать только на холодильном складе
     * - Товары с warehouseType = STANDARD можно размещать только на обычном складе
     *
     * Алгоритм:
     * 1. Получить склад через цепочку: this.shelf.warehouse
     * 2. Вызвать warehouse.canStoreProduct(product)
     * 3. Склад проверяет совместимость своего типа с типом товара
     *
     * Примеры:
     * - Молоко (REFRIGERATED) + Холодильный склад → true ✓
     * - Молоко (REFRIGERATED) + Обычный склад → false ✗
     * - Хлеб (STANDARD) + Обычный склад → true ✓
     * - Хлеб (STANDARD) + Холодильный склад → false ✗
     *
     * Используется при:
     * - Размещении товара на складе (выбор подходящей полки)
     * - Валидации попытки разместить товар
     * - Предупреждении заведующего о несовместимости
     *
     * TODO: Перенести в StorageZoneService - бизнес-правило совместимости
     * Этот метод содержит бизнес-логику и должен быть в сервисном слое,
     * а не в entity-классе
     *
     * @param product товар, который планируется разместить
     * @return true если товар можно разместить на этой полке, false иначе
     */
    @Transient
    public boolean canStoreProduct(Product product) {
        if (shelf == null || shelf.getWarehouse() == null) {
            return false;
        }
        return shelf.getWarehouse().canStoreProduct(product);
    }

}