package com.mai.siarsp.models;

import jakarta.persistence.*;
import jakarta.validation.constraints.NotNull;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.security.core.GrantedAuthority;

/**
 * Роль сотрудника в системе
 *
 * Определяет права доступа и функциональные возможности пользователя в системе СИАРСП.
 * Реализует интерфейс GrantedAuthority из Spring Security для интеграции с системой безопасности.
 *
 * Согласно ТЗ (п.228-283), в системе предусмотрено 4 роли с разными правами доступа:
 *
 * 1. ROLE_ADMIN (Владелец ИП / Системный администратор / Директор):
 *    Полный доступ ко всей информации системы
 *    - Прием и увольнение сотрудников (п.232-233)
 *    - Изменение заработной платы (п.234)
 *    - Управление должностями сотрудников (п.236-238)
 *    - Формирование/изменение/удаление договоров (п.239-241)
 *    - Управление документами на отправку и получение товара (п.242-248)
 *    - Согласование заявок на поставку (первый этап согласования)
 *    - Создание заказов клиентов
 *
 * 2. ROLE_ACCOUNTANT (Бухгалтер):
 *    Доступ к финансовым документам и бухгалтерским операциям
 *    - Составление и изменение договоров на закупку/отгрузку (п.252-253)
 *    - Составление и изменение документов на получение/отправку товара (п.254-255)
 *    - Получение оплаты за отправленный товар (п.256-257)
 *    - Осуществление оплаты за закупленный товар (п.258-259)
 *    - Согласование заявок на поставку (второй этап согласования)
 *    - Формирование товарно-транспортных накладных (ТТН)
 *
 * 3. ROLE_WAREHOUSE_MANAGER (Заведующий складом):
 *    Доступ к информации по товарам и складскому учету
 *    - Просмотр договоров о закупке и отправке товара (п.262-264)
 *    - Формирование и изменение карточек товара (п.265-267)
 *    - Изменение количества товара на складе (п.268-270)
 *    - Формирование путевых документов для водителей (п.271-272)
 *    - Формирование и изменение актов приема-передачи (п.273-274)
 *    - Создание заявок на поставку товара
 *    - Приемка товара от поставщиков
 *    - Размещение товара на складе (зоны хранения)
 *    Для мобильного приложения (п.305-314):
 *      - Просмотр накладных (приходных и расходных)
 *      - Отслеживание движений товаров
 *      - Отслеживание наличия товаров на складе
 *      - Заполнение путевых листов
 *
 * 4. ROLE_DRIVER (Водитель-экспедитор):
 *    Доступ к путевым документам и информации о доставке
 *    - Просмотр информации о конечном потребителе (адрес, контакты) (п.277-278)
 *    - Просмотр актов приема-передачи товара (п.279-280)
 *    - Внесение информации в путевой лист (конечный пробег) (п.281-283)
 *    Для мобильного приложения (п.316-322):
 *      - Просмотр путевых листов
 *      - Просмотр списка накладных на доставку
 *      - Внесение данных о конечном пробеге автомобиля
 *      - Отслеживание маршрута с контрольными точками
 *      - Отправка геолокации каждые 5 минут
 *      - Подписание актов приема-передачи
 *
 * Особенности реализации:
 * - Роли являются справочными данными и создаются при инициализации системы
 * - Каждый сотрудник (Employee) имеет ровно одну роль
 * - Смена роли сотрудника = смена прав доступа во всей системе
 * - Права проверяются на уровне контроллеров (@PreAuthorize, @Secured)
 * - Элементы UI показываются/скрываются в зависимости от роли (Thymeleaf sec:authorize)
 *
 * Связи:
 * - Одна роль может быть назначена множеству сотрудников (Employee)
 */
@Data
@NoArgsConstructor
@Entity
@Table(name = "t_role")
public class Role implements GrantedAuthority {

    // ========== ПОЛЯ ==========
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * Техническое название роли
     * Используется в Spring Security для проверки прав доступа
     *
     * Константные значения (инициализируются при развертывании системы):
     * - "ROLE_ADMIN" - администратор/директор
     * - "ROLE_ACCOUNTANT" - бухгалтер
     * - "ROLE_WAREHOUSE_MANAGER" - заведующий складом
     * - "ROLE_DRIVER" - водитель-экспедитор
     *
     * Префикс "ROLE_" обязателен для Spring Security
     * При проверке прав можно использовать как полное имя, так и без префикса:
     * - @PreAuthorize("hasRole('ADMIN')") - без префикса
     * - @PreAuthorize("hasAuthority('ROLE_ADMIN')") - с префиксом
     *
     * Используется в аннотациях контроллеров:
     * - @PreAuthorize("hasRole('ADMIN')")
     * - @PreAuthorize("hasAnyRole('ADMIN', 'ACCOUNTANT')")
     * - @Secured({"ROLE_ADMIN", "ROLE_WAREHOUSE_MANAGER"})
     */
    @NotNull
    @Column(nullable = false, unique = true)
    private String name;

    /**
     * Человекочитаемое описание роли
     * Отображается в интерфейсе администратора и при управлении сотрудниками
     */
    @NotNull
    @Column(nullable = false)
    private String description;

    // ========== КОНСТРУКТОРЫ ==========
    // Lombok @NoArgsConstructor создает конструктор без параметров

    // ========== МЕТОДЫ Spring Security ==========

    /**
     * Возвращает название роли для Spring Security
     * Реализация метода интерфейса GrantedAuthority
     *
     * Этот метод вызывается Spring Security для:
     * - Проверки прав доступа к методам контроллеров
     *   (@PreAuthorize, @PostAuthorize, @Secured)
     * - Проверки доступа к URL в SecurityConfig
     * - Условного отображения элементов UI
     *   (Thymeleaf sec:authorize="hasRole('ADMIN')")
     * - Получения списка ролей пользователя
     *   (Authentication.getAuthorities())
     *
     * Пример использования в контроллере:
     *
     * @PreAuthorize("hasRole('ADMIN')")
     * public String manageEmployees() { ... }
     *
     * @PreAuthorize("hasAnyRole('ADMIN', 'WAREHOUSE_MANAGER')")
     * public String viewProducts() { ... }
     *
     * @return техническое название роли (например, "ROLE_ADMIN")
     */
    @Override
    public String getAuthority() {
        return getName();
    }

}