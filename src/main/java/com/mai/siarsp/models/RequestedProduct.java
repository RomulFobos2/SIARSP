package com.mai.siarsp.models;

import jakarta.persistence.*;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.ToString;

/**
 * Позиция в заявке на поставку товара
 *
 * Представляет один товар в составе заявки поставщику (RequestForDelivery).
 * Указывает, какой товар и в каком количестве необходимо заказать.
 *
 * Бизнес-процесс (согласно ТЗ):
 * 1. Заведующий складом выявляет нехватку товара
 * 2. Формирует заявку на поставку (RequestForDelivery) с позициями товаров
 * 3. Каждая позиция (RequestedProduct) содержит товар и требуемое количество
 * 4. Заявка проходит согласование: Директор → Бухгалтер
 * 5. После согласования отправляется поставщику
 * 6. Поставщик привозит товар → создается Delivery с позициями Supply
 * 7. Сопоставление: RequestedProduct vs Supply (что заказали vs что привезли)
 *
 * Отличие от Supply:
 * - RequestedProduct - что ЗАКАЗАЛИ у поставщика (план)
 * - Supply - что ПОЛУЧИЛИ от поставщика (факт)
 *
 * Пример заявки:
 * Заявка поставщику "ООО Молочный комбинат":
 * - RequestedProduct: Молоко 3.2% - 200 шт.
 * - RequestedProduct: Сметана 20% - 100 шт.
 * - RequestedProduct: Творог 9% - 150 шт.
 *
 * После поставки:
 * - Supply: Молоко 3.2% - 200 шт. ✓ (совпадает)
 * - Supply: Сметана 20% - 95 шт. ⚠ (недопоставка 5 шт.)
 * - Supply: Творог 9% - 150 шт. ✓ (совпадает)
 *
 * Связи:
 * - Принадлежит одной заявке (RequestForDelivery)
 * - Ссылается на один товар (Product)
 */
@Data
@NoArgsConstructor
@Entity
@Table(name = "t_requestedProduct")
@EqualsAndHashCode(of = "id")
public class RequestedProduct {

    // ========== ПОЛЯ ==========
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * Запрашиваемое количество товара
     * Сколько единиц товара нужно заказать у поставщика
     *
     * Определяется заведующим складом на основе:
     * - Текущего остатка на складе (Product.stockQuantity)
     * - Зарезервированного количества под заказы (Product.reservedQuantity)
     * - Планируемых заказов клиентов
     * - Среднего расхода товара за период
     * - Минимального неснижаемого остатка (если задан)
     *
     * Примеры расчета:
     * - На складе: 10 шт., минимум нужно: 100 шт. → заказать 90 шт.
     * - Товара нет, зарезервировано под заказы: 50 шт. → заказать минимум 50 шт.
     * - На складе: 30 шт., средний расход: 20 шт./день, срок поставки: 3 дня → заказать 60 шт.
     *
     * Используется для:
     * - Формирования заявки поставщику
     * - Контроля выполнения заявки (сравнение с фактически поставленным)
     * - Планирования бюджета закупок
     * - Анализа недопоставок/пересортов
     */
    @Column(nullable = false)
    private int quantity;

    /**
     * Товар, который необходимо заказать
     * Ссылка на справочник товаров
     *
     * Содержит полную информацию о товаре:
     * - Наименование и артикул
     * - Категория
     * - Текущий остаток на складе
     * - История поставок (для анализа цен и надежности поставщиков)
     * - Требования к хранению (обычный склад/холодильник)
     *
     * При формировании заявки заведующий складом выбирает товар
     * из справочника и указывает требуемое количество
     */
    @ToString.Exclude
    @ManyToOne
    @JoinColumn(nullable = false)
    private Product product;

    /**
     * Заявка на поставку, к которой относится позиция
     * Одна позиция принадлежит только одной заявке
     *
     * Связь с документом, который содержит:
     * - Дату создания заявки
     * - Поставщика (к кому обращаемся)
     * - Статус согласования (черновик, на согласовании, одобрено)
     * - Список всех запрашиваемых товаров
     * - Связь с фактической поставкой (после получения товара)
     */
    @ToString.Exclude
    @ManyToOne
    @JoinColumn(nullable = false)
    private RequestForDelivery request;

    // ========== КОНСТРУКТОРЫ ==========

    /**
     * Создает новую позицию заявки на поставку
     *
     * @param product товар, который нужно заказать у поставщика
     * @param quantity требуемое количество единиц товара
     */
    public RequestedProduct(Product product, int quantity) {
        this.product = product;
        this.quantity = quantity;
    }

    // ========== МЕТОДЫ ==========

}